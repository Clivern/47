#!/bin/bash

# apt install net-tools -y

# Metrics
CLOSE_WAIT_METRIC="tcp_connections_close_wait"
ESTABLISHED_METRIC="tcp_connections_established"
TIME_WAIT_METRIC="tcp_connections_time_wait"

# The Port Number
PORT=80

# Get different connection types
CLOSE_WAIT_COUNT=$(netstat -ant | grep :$PORT | grep CLOSE_WAIT | wc -l)
ESTABLISHED_COUNT=$(netstat -ant | grep :$PORT | grep ESTABLISHED | wc -l)
TIME_WAIT_COUNT=$(netstat -ant | grep :$PORT | grep TIME_WAIT | wc -l)

# Current timestamp in milliseconds
TIMESTAMP=$(date +%s%3N)

# Output the metric in Prometheus format
echo "# HELP ${CLOSE_WAIT_METRIC} Number of TCP connections in CLOSE_WAIT state on port ${PORT}"
echo "# TYPE ${CLOSE_WAIT_METRIC} gauge"
echo "${CLOSE_WAIT_METRIC}{port=\"${PORT}\"} ${CLOSE_WAIT_COUNT} ${TIMESTAMP}"

echo "# HELP ${ESTABLISHED_METRIC} Number of TCP connections in ESTABLISHED state on port ${PORT}"
echo "# TYPE ${ESTABLISHED_METRIC} gauge"
echo "${ESTABLISHED_METRIC}{port=\"${PORT}\"} ${ESTABLISHED_COUNT} ${TIMESTAMP}"

echo "# HELP ${TIME_WAIT_METRIC} Number of TCP connections in TIME_WAIT state on port ${PORT}"
echo "# TYPE ${TIME_WAIT_METRIC} gauge"
echo "${TIME_WAIT_METRIC}{port=\"${PORT}\"} ${TIME_WAIT_COUNT} ${TIMESTAMP}"
